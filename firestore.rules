
/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model for all
 * personal data and a public-contribution model for community data. All access
 * control decisions are based on the user's authenticated UID.
 *
 * Data Structure:
 * - /users/{userId}: Contains private user profiles and all their related subcollections.
 * - /harvestListings/{listingId}: Top-level collection for all public harvest listings.
 * - /pestOutbreaks/{outbreakId}: Top-level collection for publicly readable community data.
 *
 * Key Security Decisions:
 * - Strict Ownership with Recursive Wildcard: A user can only access documents within their
 *   own data tree (i.e., under /users/{their-own-userId}). This is enforced using a recursive
 *   wildcard (`match /{path=**}`) which is more robust and less error-prone for subcollections.
 * - Public Listings: The `harvestListings` collection is readable by any authenticated user.
 *   However, creation, update, and deletion are restricted to the document owner.
 * - Public Data Contribution: The `pestOutbreaks` collection is readable by anyone
 *   (including unauthenticated users) to support a community map feature. However,
 *   only authenticated users are permitted to create new outbreak reports.
 *   To prevent tampering, updating or deleting these reports is disallowed.
 * - Subscription Fields Immutable by default: The `subscriptionPlan` and `subscriptionExpires` fields
 *   can only be changed if the update is from a free to a premium plan and the expiry date is in the future.
 *   This prevents users from downgrading or extending their own subscriptions.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //-------------------------------------------------------------------------
    // Helper Functions
    //-------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * Use this for path-based security checks.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
    * Checks if the request's user ID matches the user ID on the *existing* resource for update/delete
    * or on the *incoming* resource for create.
    */
    function isResourceOwner() {
      // For create, check the incoming resource's data.
      // For update/delete, check the existing resource's data.
      return isSignedIn() && 
        (request.auth.uid == request.resource.data.userProfileId || 
         (exists(path) && request.auth.uid == resource.data.userProfileId));
    }


    //-------------------------------------------------------------------------
    // User Profile, Crop Seasons and Expenses Rules
    //-------------------------------------------------------------------------

    match /users/{userId}/{documents=**} {
      /**
       * @description Controls all access to a user's data tree.
       * A user can read, write, update, and delete any document or subcollection
       * under their own user ID. This rule covers the user profile, crop seasons,
       * and expenses.
       */
      allow read, write: if isOwner(userId);
    }
    
    match /users/{userId} {
        // This rule specifically handles the creation of the user profile document itself.
        // On create, user starts with a free plan.
        allow create: if isOwner(userId) 
                      && request.resource.data.id == userId
                      && request.resource.data.subscriptionPlan == 'free';

        // This rule specifically handles updates to the user profile document itself.
        // Subscription upgrades from 'free' are also allowed.
        allow update: if isOwner(userId) && request.resource.data.id == resource.data.id && (
            // Case 1: Subscription is NOT changing, allowing other profile fields to be updated.
            (request.resource.data.subscriptionPlan == resource.data.subscriptionPlan && request.resource.data.subscriptionExpires == resource.data.subscriptionExpires) ||
            // Case 2: Upgrading from 'free' to 'premium'.
            (resource.data.subscriptionPlan == 'free' && 
              request.resource.data.subscriptionPlan == 'premium' && 
              request.resource.data.subscriptionExpires is timestamp && 
              request.resource.data.subscriptionExpires > request.time
            )
        );
    }
    
    //-------------------------------------------------------------------------
    // Harvest Listing Rules
    //-------------------------------------------------------------------------
    match /harvestListings/{harvestListingId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userProfileId;
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }


    //-------------------------------------------------------------------------
    // Pest Outbreak Rules
    //-------------------------------------------------------------------------

    /**
     * @description Manages access to the public pest outbreak map data.
     * @path /pestOutbreaks/{pestOutbreakId}
     * @allow (get) Any user, including anonymous ones, reading a specific outbreak report.
     * @deny (update) Any user trying to modify an existing outbreak report.
     * @principle Allows public read access and authenticated-only creation for community data.
     */
    match /pestOutbreaks/{pestOutbreakId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}
